name: Build & Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION:     '22'
      BUILD_COMMAND:    ${{ secrets.BUILD_COMMAND  || 'npm run build' }}
      PUBLIC_DIR:       ${{ secrets.PUBLIC_DIR     || 'build' }}
      FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_TARGET:  ${{ secrets.FIREBASE_TARGET || '' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Verify Node version
        run: node --version
        # this should print v20.x.x

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: ${{ env.BUILD_COMMAND }}

      - name: Deploy to Firebase Hosting
        uses: w9jds/firebase-action@v1.5.0
        # remove working-directory hereâ€¦
        with:
          args: >
            deploy
            --project ${{ env.FIREBASE_PROJECT }}
            ${{ env.FIREBASE_TARGET && format('--only hosting:%s', env.FIREBASE_TARGET) }}
            --public frontend/${{ env.PUBLIC_DIR }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

